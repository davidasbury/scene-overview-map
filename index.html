<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>3D Scene Overview map</title>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        z-index: -1;
      }

      #overviewDiv {
        position: absolute;
        bottom: 18px;
        right: 220px;
        width: 200px;
        height: 133px;
        border: 1px solid black;
        z-index: 1;
        overflow: hidden;
      }

      #extentDiv {
        background-color: rgba(0, 0, 0, 0.5);
        position: absolute;
        z-index: 2;
      }
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.24/"></script>
    <script type="module" src=https://js.arcgis.com/calcite-components/1.0.0-beta.95/calcite.esm.js></script>
    <link rel="stylesheet" type="text/css" href=https://js.arcgis.com/calcite-components/1.0.0-beta.95/calcite.css />

    <script type="module">
      import MapView from 'https://js.arcgis.com/4.24/@arcgis/core/views/MapView.js';
      import Map from 'https://js.arcgis.com/4.24/@arcgis/core/Map.js';
      import SpatialReference from 'https://js.arcgis.com/4.24/@arcgis/core/geometry/SpatialReference.js';
      import * as reactiveUtils from 'https://js.arcgis.com/4.24/@arcgis/core/core/reactiveUtils.js';
      import SceneView from "https://js.arcgis.com/4.24/@arcgis/core/views/SceneView.js";
      import Graphic from "https://js.arcgis.com/4.24/@arcgis/core/Graphic.js";
      import * as promiseUtils from "https://js.arcgis.com/4.24/@arcgis/core/core/promiseUtils.js";
      import * as projection from "https://js.arcgis.com/4.24/@arcgis/core/geometry/projection.js";
      import Basemap from "https://js.arcgis.com/4.24/@arcgis/core/Basemap.js";
      import Extent from "https://js.arcgis.com/4.24/@arcgis/core/geometry/Extent.js";
      import Point from "https://js.arcgis.com/4.24/@arcgis/core/geometry/Point.js";

      // Load the projection engine  
      projection.load().then(function() {

        // Create a basemap for the main map
        let mainBasemap = new Basemap({
          portalItem: {
            id: "1544b585aeba430a8a41b29457f2b580"  //Andy Skinner's Equal Earth basemap
//            id: "8dda0e7b5e2d4fafa80132d59122268c"  // WGS84 Streets Vector webmap
//            id: "8d91bd39e873417ea21673e0fee87604" // nova basemap
          }
        });
        // Create a Map with a basemap, to be used in the main view
        const mainMap = new Map({
          basemap: mainBasemap,
        });

        // Create another Map, to be used in the overview 
        const overviewMap = new Map({
          basemap: "gray-vector",
          ground: "world-elevation"
        });

        // Create the main MapView
        const mainView = new MapView({
          container: "viewDiv",
          map: mainMap,
          spatialReference:{
            wkid:8857   // Equal Earth
//            wkid:4326     // WGS84
//            wkid:3857     // WebMercator
          },
          // Set the initial center point and zoom level
          center:{
            x:-120,
            y:35
          },
          zoom: 5,
          constraints: {
            rotationEnabled: false
          }
        });
        // Transform center point of mapView because SceneViewer
        // can only deal with WGS84 or WebMercator in global mode
        const overviewSpatialReference = new SpatialReference({
            wkid: 3857 //WebMercator
          });
        console.log("mainExtent: ",mainView.extent);

        let transformCenter = projection.project(mainView.center,overviewSpatialReference);

        // Create a SceneView for the overview map

          const overView = new SceneView({
            container: "overviewDiv",
            map: overviewMap,
            viewingMode: "global",
            alphaCompositingEnabled: true,  
            environment:{
                background: {
                  type: "color",
                  color: [247, 247, 247, 1]
                },
                lighting: {
                  type: "virtual"
                },
                atmosphereEnabled: false,
                starsEnabled:false
              },
            camera: {
              position: {
                spatialReference: {
                  latestWkid: 3857,
                  wkid: 102100
                },
                // Get center point from main map (after transform)
                x: transformCenter.x,
                y: transformCenter.y,
                z: 17000000
              },
              heading: 0,
              tilt: 0
            }
          });
        
        // Remove the default widgets
        overView.ui.components = [];

        //output to console  
        console.log("mainSR: ",mainView.spatialReference.wkid);
        console.log("variableSR: ",overviewSpatialReference.wkid);
        console.log("mainCenterX: ",mainView.center.x,"mainCenterY: ",mainView.center.y);
        console.log("transformCenterX: ",transformCenter.x,"transformCenterY: ",transformCenter.y);
        console.log("mainScale: ",mainView.scale)

        overView.when(() => {
          mainView.when(() => {
            drawExtentAndSync();
          });
        });

        const extentDebouncer = promiseUtils.debounce(() => {
          if (mainView.stationary) {
            overView.goTo({
              center: mainView.center,
              scale:
                mainView.scale *
                2 *
                Math.max(
                  mainView.width / overView.width,
                  mainView.height / overView.height
                )
            });
          }
        });
      
        function drawExtentAndSync() {
          const extent3Dgraphic = new Graphic({
            geometry: null,
            symbol: {
              type: "simple-fill",
              color: [0, 0, 0, 0],
              outline:  {
                width: 1,
                color: [255, 0, 0, 1]
              }
            }
          });
          overView.graphics.add(extent3Dgraphic);

 
          reactiveUtils.watch(
            () => mainView.extent,
              // Sync the overview map location
              // whenever the main view is stationary
              (extent) => {
                //transform the mainView extent into something that SceneViewer can handle
                const transformExtent = projection.project(extent,overviewSpatialReference);
                  extentDebouncer().then(() => {
                    extent3Dgraphic.geometry = transformExtent;
                  });
                },
              {
              initial: true
              }
          );
        }
      

 /*       //sync map and scene views
        const views = [mainView, overView];
        let active;
        const sync = (source) => {
          if (!active || !active.viewpoint || active !== source) {
            return;
          }

          for (const view of views) {
            let transformViewpoint = projection.project(active.viewpoint,overviewSpatialReference);
            if (view !== active) {
              view.transformViewpoint = active.transformViewpoint;
            }
          }
        };

        for (const view of views) {
          view.watch(["interacting", "animation"], () => {
            active = view;
            sync(active);
          });

          view.watch("viewpoint", () => sync(view));
        }*/
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="overviewDiv"><div id="extentDiv"></div></div>
  </body>
</html>